version: '3'

tasks:
  go:mod:tidy:
    summary: Update Go depencies
    internal: true
    cmds:
      - go mod tidy

  build:frontend:
    summary: Build the frontend project
    dir: frontend
    sources:
      - "**/*"
    generates:
      - dist/**/*
    deps:
      - task: generate:bindings
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
    cmds:
      - deno task build

  dev:frontend:
    summary: Runs the frontend in development mode
    dir: frontend
    cmds:
      - deno task serve

  generate:bindings:
    label: generate:bindings
    summary: Generates bindings for the frontend
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.[jt]s"
      - exclude: frontend/**/*
      - frontend/bindings/**/*  # Rerun when switching between dev/production mode causes changes in output
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - frontend/bindings/**/*
    cmds:
      - wails3 generate bindings -clean=true -ts -i -noevents -models types
      - sed -i 's#@wailsio/runtime#wailsio/runtime#' frontend/bindings/**/* # Fix npm imports for Deno
      - sed -i 's#.js#.ts#' frontend/bindings/**/* # Fix strange .js import bug on -ts
