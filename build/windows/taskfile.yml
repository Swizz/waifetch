version: '3'

includes:
  common: ../taskfile.yml

tasks:
  build:
    summary: Builds the application using native Go cross-compilation
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
          DEV:
            ref: .DEV
      - task: generate:syso
    cmds:
      - go build {{.BUILD_FLAGS}} -o './build/bin/waifetch-{{.VERSION}}-{{.GOARCH}}.exe'
    vars:
      BUILD_FLAGS: '{{if eq .DEV "true"}}-buildvcs=false -gcflags=all="-l"{{else}}-tags production -trimpath -buildvcs=false -ldflags="-w -s -H windowsgui"{{end}}'
      GOARCH: amd64
      VERSION:
        sh: git describe --tags --always --abbrev=0 | sed 's/^v//'
    env:
      CGO_ENABLED: 1
      GOOS: windows
      GOARCH: '{{.GOARCH}}'

  generate:icons:
    summary: Generates Windows '.ico'
    internal: true
    dir: build
    sources:
      - "appicon.png"
    generates:
      - "windows/icon.ico"
    cmds:
      - wails3 generate icons -input appicon.png -windowsfilename windows/icon.ico

  inject:version:
    summary: Injects current git version in metafiles
    internal: true
    dir: build
    cmds:
      - sed -i "s/'{{`{{.VERSION}}`}}'/{{.VERSION}}/g" ./windows/exe.manifest
      - sed -i "s/'{{`{{.VERSION}}`}}'/{{.VERSION}}/g" ./windows/info.json
    vars:
      VERSION:
        sh: git describe --tags --always --abbrev=0 | sed 's/^v//'

  restore:version:
    desc: Restores the metafiles with placeholders
    internal: true
    dir: build
    cmds:
      - git checkout ./windows/exe.manifest
      - git checkout ./windows/info.json

  generate:syso:
    summary: Generates Windows `.syso` file
    internal: true
    dir: build
    deps:
      - task: generate:icons
      - task: inject:version
    sources:
      - "windows/icon.ico"
      - "windows/exe.manifest"
      - "windows/info.json"
    generates:
      - "../wails_windows_{{.GOARCH}}.syso"
    cmds:
      - defer: { task: restore:version }
      - wails3 generate syso -arch {{.GOARCH}} -icon windows/icon.ico -manifest windows/exe.manifest -info windows/info.json -out ../wails_windows_{{.GOARCH}}.syso
    vars:
      GOARCH: amd64

  run:
    summary: Runs the application
    cmds:
      - platforms: [windows]
        cmd: Start-Process -FilePath './build/bin/waifetch-{{.VERSION}}-{{.GOARCH}}.exe'
    vars:
      GOARCH: amd64
      VERSION:
        sh: git describe --tags --always --abbrev=0 | sed 's/^v//'

