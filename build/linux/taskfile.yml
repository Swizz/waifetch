version: '3'

includes:
  common: ../taskfile.yml

tasks:
  build:
    summary: Builds the application using native Go cross-compilation
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
          DEV:
            ref: .DEV
    cmds:
      - go build {{.BUILD_FLAGS}} -o './build/bin/waifetch-{{.VERSION}}-{{.GOARCH}}.bin'
    vars:
      BUILD_FLAGS: '{{if eq .DEV "true"}}-buildvcs=false -gcflags=all="-l"{{else}}-tags production -trimpath -buildvcs=false -ldflags="-w -s"{{end}}'
      GOARCH: amd64
      VERSION:
        sh: git describe --tags --always --abbrev=0 | sed 's/^v//'
    env:
      CGO_ENABLED: 1
      GOOS: linux
      GOARCH: '{{.GOARCH}}'

  run:
    summary: Runs the application
    cmds:
      - ./build/bin/waifetch-{{.VERSION}}-{{.GOARCH}}.bin
    vars:
      GOARCH: amd64
      VERSION:
        sh: git describe --tags --always --abbrev=0 | sed 's/^v//'
